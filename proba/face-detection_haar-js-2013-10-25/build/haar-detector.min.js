/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.4
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/(function(){function t(t,i,e){var n,h,a,s,r,l,o,c=t.length,d=i*e,u=new f(d),y=new g(d),w=new g(d),x=new g(d);for(s=0,a=0,n=h=0;i>s;)o=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,o&=255,n+=o,h+=o*o,u[s]=o,y[s]=n,w[s]=h,x[s]=o,s++,a+=4;for(r=0,l=1,s=i,a=i<<2,n=h=0;c>a;)o=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,o&=255,n+=o,h+=o*o,u[s]=o,y[s]=y[s-i]+n,w[s]=w[s-i]+h,x[s]=x[s+1-i]+(o+u[s-i])+(l>1?x[s-i-i]:0)+(r>0?x[s-1-i]:0),r++,s++,a+=4,r>=i&&(r=0,l++,n=h=0);return{gray:u,integral:y,squares:w,tilted:x}}function i(t,i,e){var n,h,a,s,r,l,o,c,d,u,w,x=t.length,m=new f(x),p=new g(x);for(n=0;i>n;n++)m[n]=0,m[n+i]=0,m[n+x-i]=0,m[n+x-i-i]=0,p[n]=0,p[n+x-i]=0;for(h=0,a=0;e>h;h++,a+=i)m[0+a]=0,m[1+a]=0,m[i-1+a]=0,m[i-2+a]=0,p[0+a]=0,p[i-1+a]=0;for(n=2;i-2>n;n++)for(s=0,h=2,a=i<<1;e-2>h;h++,a+=i)o=n+a,c=o+i,d=c+i,u=o-i,w=u-i,s=0+(t[w-2]<<1)+(t[u-2]<<2)+(t[o-2]<<2)+t[o-2]+(t[c-2]<<2)+(t[d-2]<<1)+(t[w-1]<<2)+(t[u-1]<<3)+t[u-1]+(t[o-1]<<4)-(t[o-1]<<2)+(t[c-1]<<3)+t[c-1]+(t[d-1]<<2)+(t[w]<<2)+t[w]+(t[u]<<4)-(t[u]<<2)+(t[o]<<4)-t[o]+(t[c]<<4)-(t[c]<<2)+(t[d]<<2)+t[d]+(t[w+1]<<2)+(t[u+1]<<3)+t[u+1]+(t[o+1]<<4)-(t[o+1]<<2)+(t[c+1]<<3)+t[c+1]+(t[d+1]<<2)+(t[w+2]<<1)+(t[u+2]<<2)+(t[o+2]<<2)+t[o+2]+(t[c+2]<<2)+(t[d+2]<<1),m[o]=(255&(4294967295&103*s+8192)>>>14)>>>0;for(n=1;i-1>n;n++)for(h=1,a=i;e-1>h;h++,a+=i)o=a+n,c=o+i,u=o-i,r=0-m[u-1]+m[u+1]-m[o-1]-m[o-1]+m[o+1]+m[o+1]-m[c-1]+m[c+1],l=0+m[u-1]+m[u]+m[u]+m[u+1]-m[c-1]-m[c]-m[c]-m[c+1],p[o]=y(r)+y(l);for(n=0,s=0;i>n;)s+=p[n],p[n]=s,n++;for(n=i,a=0,s=0;x>n;)s+=p[n],p[n]=p[n-i]+s,n++,a++,a>=i&&(a=0,s=0);return p}function e(t,i,e){var h,a,s,r,l,o,c,u=t.length,g=new Array(u),f=[],y=0,w=!1;for(s=0;u>s;s++)g[s]=0;for(s=0;u>s;s++){for(w=!1,r=0;s>r;r++)t[r].almostEqual(t[s])&&(w=!0,g[s]=g[r]);w||(g[s]=y,y++)}for(h=new Array(y),a=new Array(y),s=0;y>s;s++)h[s]=0,a[s]=new d;for(s=0;u>s;s++)c=g[s],h[c]++,a[c].add(t[s]);for(s=0;y>s;s++)l=h[s],l>=i&&(o=1/(l+l),c=new d(o*(2*a[s].x+l),o*(2*a[s].y+l),o*(2*a[s].width+l),o*(2*a[s].height+l)),f.push(c));for(1!=e&&(e=1/e),u=f.length,s=0;u>s;s++)for(r=s+1;u>r;r++)!f[s].isInside&&f[s].inside(f[r])?f[s].isInside=!0:!f[r].isInside&&f[r].inside(f[s])&&(f[r].isInside=!0);for(s=u;--s>=0;)f[s].isInside?f.splice(s,1):(1!=e&&f[s].scale(e),f[s].round().computeArea());return f.sort(n)}function n(t,i){return t.area-i.area}function h(t,i){return t.index-i.index}function a(t){return t[1].length&&(t[0]=t[0].concat(t[1]).sort(h)),t[0]}function r(t){var i,e,n,h,a,r,l,o,c,d,u,g,f,y,w,x,m,p,v,S,I,C,q,_,A,H,b,P,R,T,M,L,D,E,W,j,z,k,F,V,O,U,N,B,G,J,K,Q,X,Y=Y||Math.sqrt,Z=[],$=t.haardata,ti=t.scaledSelection,ii=ti.width,ei=ti.height,ni=ii*ei,hi=ni-1,ai=$.size1,si=$.size2,ri=ti.x,li=ti.y,oi=$.stages.length,ci=t.cannyLow,di=t.cannyHigh,ui=t.canny,gi=t.integral,fi=t.squares,yi=t.tilted,wi=t.scale,xi=t.increment,mi=t.i||0,pi=t.doCannyPruning;for(w=0,x=ii-1,m=0,p=ni-ii,n=~~(wi*ai),i=~~(n*xi),h=~~(wi*si),e=~~(h*xi),c=h*ii,d=e*ii,a=li*d,xl=ii-n,yl=ei-h,v=n*h,S=1/v,l=li,o=a;yl>l;l+=e,o+=d)for(r=ri;xl>r;r+=i)if(u=r-1+o-ii,g=u+n,f=u+c,y=f+n,u=0>u?0:u>hi?hi:u,g=0>g?0:g>hi?hi:g,f=0>f?0:f>hi?hi:f,y=0>y?0:y>hi?hi:y,!(pi&&(_=S*(ui[y]-ui[f]-ui[g]+ui[u]),ci>_||_>di))){for(I=S*(gi[y]-gi[f]-gi[g]+gi[u]),C=S*(fi[y]-fi[f]-fi[g]+fi[u]),q=C-I*I,q=q>1?Y(q):1,A=!0,s=0;oi>s;s++){for(H=$.stages[s],b=H.thres,P=H.trees,R=P.length,X=0,T=0;R>T;T++)for(D=P[T].feats,M=0;;){if(E=D[M],W=E.rects,j=W.length,z=E.thres,k=0,E.tilt)for(F=0;j>F;F++)V=W[F],O=r+~~(wi*V[0]),U=(l-1+~~(wi*V[1]))*ii,N=r+~~(wi*(V[0]+V[2])),B=(l-1+~~(wi*(V[1]+V[2])))*ii,G=r+~~(wi*(V[0]-V[3])),J=(l-1+~~(wi*(V[1]+V[3])))*ii,K=r+~~(wi*(V[0]+V[2]-V[3])),Q=(l-1+~~(wi*(V[1]+V[2]+V[3])))*ii,O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,G=w>G?w:G>x?x:G,K=w>K?w:K>x?x:K,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,J=m>J?m:J>p?p:J,Q=m>Q?m:Q>p?p:Q,k+=V[4]*(yi[K+Q]-yi[G+J]-yi[N+B]+yi[O+U]);else for(F=0;j>F;F++)V=W[F],O=r-1+~~(wi*V[0]),N=r-1+~~(wi*(V[0]+V[2])),U=ii*(l-1+~~(wi*V[1])),B=ii*(l-1+~~(wi*(V[1]+V[3]))),O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,k+=V[4]*(gi[N+B]-gi[O+B]-gi[N+U]+gi[O+U]);if(L=z*q>k*S?0:1){if(E.has_r){X+=E.r_val;break}M=E.r_node}else{if(E.has_l){X+=E.l_val;break}M=E.l_node}}if(A=X>b?!0:!1,!A)break}A&&Z.push({index:mi,x:r,y:l,width:n,height:h})}return Z}function l(t,i){for(var n=0,h=i.length;h>n;n++)i[n]=new d(i[n]);t.objects=e(i,t.min_neighbors,t.Ratio,t.Selection),t.Ready=!0,t.onComplete&&t.onComplete.call(t)}var o,c,d,u="0.4.4";o="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:this.HAAR={},o.VERSION=u;var g="undefined"!=typeof Float32Array?Float32Array:Array,f="undefined"!=typeof Uint8Array?Uint8Array:Array,y=Math.abs,w=Math.max,x=Math.min,m=(Math.floor,Math.round),p=(Math.sqrt,Array.prototype.slice);c=o.Detector=function(t,i){this.haardata=t,this.Ready=!1,this.doCannyPruning=!1,this.Canvas=null,this.Selection=null,this.scaledSelection=null,this.objects=null,this.TimeInterval=null,this.DetectInterval=30,this.Ratio=.5,this.cannyLow=20,this.cannyHigh=100,this.Parallel=i||!1,this.onComplete=null},c.prototype={constructor:c,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:!1,Ready:!1,onComplete:null,clearCache:function(){return this.haardata=null,this.canny=null,this.integral=null,this.squares=null,this.tilted=null,this},cascade:function(t){return this.haardata=t,this},image:function(e,n,h){if(e){var a,s,r,l,o,c,d,u;this.Canvas||(this.Canvas=h||document.createElement("canvas")),u=this.Ratio="undefined"==typeof n?.5:n,this.Ready=!1,l=this.origWidth=e instanceof HTMLVideoElement?e.videoWidth:e.width,o=this.origHeight=e instanceof HTMLVideoElement?e.videoHeight:e.height,c=this.width=this.Canvas.width=m(u*l),d=this.height=this.Canvas.height=m(u*o),a=this.Canvas.getContext("2d"),a.drawImage(e,0,0,l,o,0,0,c,d),s=a.getImageData(0,0,c,d),r=t(s.data,s.width,s.height),this.integral=r.integral,this.squares=r.squares,this.tilted=r.tilted,this.canny=i(r.gray,c,d),r.gray=null,r.integral=null,r.squares=null,r.tilted=null,r=null}return this},interval:function(t){return t>0&&(this.DetectInterval=t),this},cannyThreshold:function(t){return t&&"undefined"!=typeof t.low&&(this.cannyLow=t.low),t&&"undefined"!=typeof t.high&&(this.cannyHigh=t.high),this},selection:function(){var t=p.call(arguments),i=t.length;return this.Selection=1==i&&"auto"==t[0]||!i?null:d.prototype.data.apply(new d,t),this},complete:function(t){return this.onComplete=t,this},detect:function(t,i,e,n,s){var o=this,c=o.haardata.size1,u=o.haardata.size2;if(o.Selection||(o.Selection=new d(0,0,o.origWidth,o.origHeight)),o.Selection.x="auto"==o.Selection.x?0:o.Selection.x,o.Selection.y="auto"==o.Selection.y?0:o.Selection.y,o.Selection.width="auto"==o.Selection.width?o.origWidth:o.Selection.width,o.Selection.height="auto"==o.Selection.height?o.origHeight:o.Selection.height,o.scaledSelection=o.Selection.clone().scale(o.Ratio).round(),t="undefined"==typeof t?1:t,i="undefined"==typeof i?1.25:i,e="undefined"==typeof e?.5:e,n="undefined"==typeof n?1:n,o.doCannyPruning="undefined"==typeof s?!0:s,o.maxScale=x(o.width/c,o.height/u),o.scale=t,o.min_neighbors=n,o.scale_inc=i,o.increment=e,o.Ready=!1,o.Parallel&&o.Parallel.isSupported()){var g,f=[],y=0;for(g=t;g<=o.maxScale;g*=o.scale_inc)f.push({haardata:o.haardata,width:o.width,height:o.height,scaledSelection:{x:o.scaledSelection.x,y:o.scaledSelection.y,width:o.scaledSelection.width,height:o.scaledSelection.height},integral:o.integral,squares:o.squares,tilted:o.tilted,doCannyPruning:o.doCannyPruning,canny:o.doCannyPruning?o.canny:null,cannyLow:o.cannyLow,cannyHigh:o.cannyHigh,maxScale:o.maxScale,min_neighbors:o.min_neighbors,scale_inc:o.scale_inc,increment:o.increment,scale:g,i:y++});new o.Parallel(f,{synchronous:!1}).require(h,r,a).map(r).reduce(a).then(function(t){l(o,t)})}else{var w=[],m=function(){o.scale<=o.maxScale?(w=w.concat(r(o)),o.scale*=o.scale_inc,o.TimeInterval=setTimeout(m,o.DetectInterval)):(clearTimeout(o.TimeInterval),l(o,w))};o.TimeInterval=setTimeout(m,o.DetectInterval)}return this}},d=o.Feature=function(t,i,e,n,h){this.data(t,i,e,n,h)},d.prototype={constructor:d,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(t,i,e,n,h){return t&&t instanceof d?this.copy(t):t&&t instanceof Object?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.index=t.index||0,this.area=t.area||0,this.isInside=t.isInside||!1):(this.x=t||0,this.y=i||0,this.width=e||0,this.height=n||0,this.index=h||0,this.area=0,this.isInside=!1),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},scale:function(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this},round:function(){return this.x=~~(this.x+.5),this.y=~~(this.y+.5),this.width=~~(this.width+.5),this.height=~~(this.height+.5),this},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(t){return this.x>=t.x&&this.y>=t.y&&this.x+this.width<=t.x+t.width&&this.y+this.height<=t.y+t.height?!0:!1},contains:function(t){return t.inside(this)},equal:function(t){return t.x==this.x&&t.y==this.y&&t.width==this.width&&t.height==this.height?!0:!1},almostEqual:function(t){var i=.2*w(t.width,this.width),e=.2*w(t.height,this.height);return y(this.x-t.x)<=i&&y(this.y-t.y)<=e&&y(this.width-t.width)<=i&&y(this.height-t.height)<=e?!0:!1},clone:function(){var t=new d;return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.index=this.index,t.area=this.area,t.isInside=this.isInside,t},copy:function(t){return t&&t instanceof d&&(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.index=t.index,this.area=t.area,this.isInside=t.isInside),this},toString:function(){return"[ x: "+this.x+", y: "+this.y+", width: "+this.width+", height: "+this.height+" ]"}}}).call(this);